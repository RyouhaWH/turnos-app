# Redirección HTTP a HTTPS para el sitio principal 
server { 
    listen 80; 
    listen [::]:80; 
    server_name www.jorgewh.cl jorgewh.cl; 
    return 301 https://$server_name$request_uri;  
} 
 
# Redirección HTTP a HTTPS para el subdominio 
server { 
    if ($host = amzoma.jorgewh.cl) { 
        return 301 https://$host$request_uri;  
    } # managed by Certbot 
 
 
    listen 80; 
    listen [::]:80; 
    server_name amzoma.jorgewh.cl; 
    return 301 https://$server_name$request_uri;  
 
 
} 
 
# Sitio principal HTTPS 
server { 
    server_name www.jorgewh.cl jorgewh.cl; 
    root /var/www/html; 
    index index.html; 
     
    location / { 
        try_files $uri $uri/ =404; 
    } 
     
    listen [::]:443 ssl ipv6only=on; 
    listen 443 ssl; 
    ssl_certificate /etc/letsencrypt/live/jorgewh.cl/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/jorgewh.cl/privkey.pem; 
    include /etc/letsencrypt/options-ssl-nginx.conf; 
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; 
} 
 
# App Laravel en subdominio HTTPS 
server { 
    server_name amzoma.jorgewh.cl; 
    root /var/www/amzoma/current/public; 
    index index.php index.html; 
    
    # Configuración para headers grandes (Laravel Inertia)
    large_client_header_buffers 4 32k;
    client_header_buffer_size 8k;
     
    location / { 
        try_files $uri $uri/ /index.php?$query_string; 
    } 
     
    location ~ \.php$ { 
        try_files $uri =404; 
        fastcgi_pass unix:/var/run/php/php8.3-fpm.sock; 
        fastcgi_index index.php; 
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name; 
        include fastcgi_params; 
        
        # Buffers adicionales para FastCGI
        fastcgi_buffer_size 32k;
        fastcgi_buffers 8 32k;
    } 
     
    location ~* \.(jpg|jpeg|gif|png|ico|css|js|svg|woff|woff2|ttf|map)$ { 
        expires max; 
        add_header Cache-Control "public, immutable"; 
        access_log off; 
        log_not_found off; 
    } 
     
    listen [::]:443 ssl; 
    listen 443 ssl; 
    ssl_certificate /etc/letsencrypt/live/amzoma.jorgewh.cl/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/amzoma.jorgewh.cl/privkey.pem;     
    include /etc/letsencrypt/options-ssl-nginx.conf; 
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; 
 
}